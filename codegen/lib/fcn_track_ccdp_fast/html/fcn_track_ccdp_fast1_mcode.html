<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T5U3">uv_opt</span>, <span class="var type1" id="S3T5U4">uw_opt</span>, <span class="var type1" id="S4T76U5">predict_s</span> ] = fcn_track_ccdp_fast( <span class="var type1" id="S5T75U8">pS</span>, <span class="var type1" id="S6T10U9">pEst</span>, <span class="var type1" id="S7T5U10">H</span>, <span class="var type1" id="S8T5U11">T</span>, <span class="var type1" id="S9T1U12">ccdp</span>, <span class="var type1" id="S10T5U13">threshold_track</span>, <span class="var type1" id="S11T7U14">costparam</span>,<span class="var type1" id="S12T70U15">nextstate</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% ---------------------------------------------------------------%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% Find the optimal control which follows the target </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% without collision and occlusion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% -- Input -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% current position</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% pEst: estimated position of the target</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% -- Output -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% ----------------------------------------------------------------%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% -- [ settings for visibility cost ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo " id="T5:U12"><span class="var type1" id="S13T5U18">nvis</span> = <span class="mxinfo " id="T5:U14">20</span></span>; <span class="comment">% the number of angles to compute visibility cost</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T5:U15">[<span class="var type1" id="S14T5U23">rlen</span>, <span class="var type1" id="S15T5U24">clen</span>] = size(<span class="mxinfo " id="T2:U18"><span class="var type1" id="S9T1U28">ccdp</span>.xs</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">%ccdp.cvis = zeros([rlen,clen,H]); % initialize the visibility cost</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% -- [ settings for tracking cost ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T5:U20"><span class="var type1" id="S17T5U32">ndir</span>=<span class="mxinfo " id="T5:U22"><span class="var type1" id="S11T7U34">costparam</span>.ndir</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%s_dirs = costparam.s_dirs;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% -- [ Compute one-step cost ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T85:U24"><span class="var type1" id="S18T85U38">ccdp_ctrack</span> = <span class="mxinfo " id="T85:U26">zeros(<span class="var type1" id="S14T5U41">rlen</span>,<span class="var type1" id="S15T5U42">clen</span>,<span class="var type1" id="S17T5U43">ndir</span>,<span class="mxinfo " id="T5:U30"><span class="var type1" id="S7T5U45">H</span>+<span class="mxinfo " id="T5:U32">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T86:U33"><span class="var type1" id="S20T86U49">ccdp_cvis</span> = <span class="mxinfo " id="T86:U35">zeros(<span class="var type1" id="S14T5U52">rlen</span>,<span class="var type1" id="S15T5U53">clen</span>,<span class="mxinfo " id="T5:U38"><span class="var type1" id="S7T5U55">H</span>+<span class="mxinfo " id="T5:U40">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%ccdp.ctrack(1).val = zeros(rlen,clen,ndir);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T86:U41"><span class="var type1" id="S21T86U59">ccdp_cavoid</span> = <span class="mxinfo " id="T86:U43">zeros(<span class="var type1" id="S14T5U62">rlen</span>,<span class="var type1" id="S15T5U63">clen</span>,<span class="mxinfo " id="T5:U46"><span class="var type1" id="S7T5U65">H</span>+<span class="mxinfo " id="T5:U48">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T85:U49"><span class="var type1" id="S22T85U69">ccdp_cconst</span>= <span class="mxinfo " id="T85:U51">zeros(<span class="var type1" id="S14T5U72">rlen</span>,<span class="var type1" id="S15T5U73">clen</span>,<span class="var type1" id="S17T5U74">ndir</span>,<span class="mxinfo " id="T5:U55"><span class="var type1" id="S7T5U76">H</span>+<span class="mxinfo " id="T5:U57">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S23T5U80">tt</span>=<span class="mxinfo " id="T5:U59">1</span>:<span class="var type1" id="S7T5U83">H</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">    <span class="comment">% --- [ Cost: Cvis ]  --- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">    <span class="comment">% distance and angle from the target's prediction to grids</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">    <span class="mxinfo " id="T2:U61"><span class="var type1" id="S24T2U86">dist2target</span> = <span class="mxinfo " id="T2:U63"><span class="mxinfo " id="T2:U64">(<span class="mxinfo " id="T2:U65"><span class="mxinfo " id="T2:U66"><span class="var type1" id="S9T1U92">ccdp</span>.xs</span>-<span class="mxinfo " id="T5:U68"><span class="mxinfo " id="T11:U69"><span class="mxinfo " id="T100:U70"><span class="var type1" id="S6T10U97">pEst</span>(<span class="var type1" id="S23T5U98">tt</span>)</span>.mean</span>(<span class="mxinfo " id="T5:U73">1</span>)</span></span>).^2</span>+ <span class="mxinfo " id="T2:U74">(<span class="mxinfo " id="T2:U75"><span class="mxinfo " id="T2:U76"><span class="var type1" id="S9T1U106">ccdp</span>.ys</span>-<span class="mxinfo " id="T5:U78"><span class="mxinfo " id="T11:U79"><span class="mxinfo " id="T100:U80"><span class="var type1" id="S6T10U111">pEst</span>(<span class="var type1" id="S23T5U112">tt</span>)</span>.mean</span>(<span class="mxinfo " id="T5:U83">2</span>)</span></span>).^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">    <span class="mxinfo " id="T2:U84"><span class="var type1" id="S25T2U118">angle2target</span> = <span class="mxinfo " id="T2:U86"><span class="mxinfo " id="T2:U87">round(<span class="mxinfo " id="T2:U88"><span class="mxinfo " id="T92:U89"><span class="mxinfo " id="T92:U90">(<span class="mxinfo " id="T2:U91"><span class="mxinfo " id="T2:U92">atan2(<span class="mxinfo " id="T2:U93"><span class="mxinfo " id="T2:U94"><span class="var type1" id="S9T1U131">ccdp</span>.ys</span>-<span class="mxinfo " id="T5:U96"><span class="mxinfo " id="T11:U97"><span class="mxinfo " id="T100:U98"><span class="var type1" id="S6T10U136">pEst</span>(<span class="var type1" id="S23T5U137">tt</span>)</span>.mean</span>(<span class="mxinfo " id="T5:U101">2</span>)</span></span>,<span class="mxinfo " id="T2:U102"><span class="mxinfo " id="T2:U103"><span class="var type1" id="S9T1U142">ccdp</span>.xs</span>-<span class="mxinfo " id="T5:U105"><span class="mxinfo " id="T11:U106"><span class="mxinfo " id="T100:U107"><span class="var type1" id="S6T10U147">pEst</span>(<span class="var type1" id="S23T5U148">tt</span>)</span>.mean</span>(<span class="mxinfo " id="T5:U110">1</span>)</span></span>)</span>+<span class="mxinfo " id="T5:U111">pi</span></span>)/<span class="mxinfo " id="T5:U112">2</span></span>/<span class="mxinfo " id="T5:U113">pi</span></span>*<span class="mxinfo " id="T5:U114"><span class="var type1" id="S13T5U156">nvis</span></span></span>)</span>+<span class="mxinfo " id="T5:U116">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">    <span class="mxinfo " id="T101:U117"><span class="mxinfo " id="T101:U118"><span class="var type1" id="S25T2U161">angle2target</span>(<span class="mxinfo " id="T88:U120"><span class="var type1" id="S25T2U163">angle2target</span>==<span class="mxinfo " id="T5:U122">9</span></span>)</span>=<span class="mxinfo " id="T5:U123">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="mxinfo " id="T27:U124"><span class="var type1" id="S29T27U168">minradius</span> = <span class="mxinfo " id="T27:U126">zeros(<span class="mxinfo " id="T5:U127">1</span>,<span class="mxinfo " id="T5:U128"><span class="var type1" id="S13T5U172">nvis</span></span>)</span></span>; <span class="comment">% distance between the target and an obstacle in nvis directions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">    <span class="mxinfo " id="T2:U130"><span class="var type1" id="S30T2U175">cvistmp</span> = <span class="mxinfo " id="T2:U132">zeros(<span class="mxinfo " id="T25:U133">[<span class="var type1" id="S14T5U180">rlen</span>,<span class="var type1" id="S15T5U181">clen</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S31T5U184">ii</span>=<span class="mxinfo " id="T5:U137">1</span>:<span class="var type1" id="S13T5U187">nvis</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">        <span class="mxinfo " id="T89:U139"><span class="var type1" id="S32T89U190">obsidx</span> = <span class="mxinfo " id="T89:U141"><span class="mxinfo " id="T89:U142"><span class="mxinfo " id="T89:U143"><span class="mxinfo " id="T6:U144"><span class="var type1" id="S9T1U195">ccdp</span>.gmap</span>(:)</span>==<span class="mxinfo " id="T5:U146">1</span></span> &amp; <span class="mxinfo " id="T102:U147"><span class="mxinfo " id="T101:U148"><span class="var type1" id="S25T2U201">angle2target</span>(:)</span>==<span class="var type1" id="S31T5U203">ii</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T13:U151"><span class="mxinfo " id="T5:U152">sum(<span class="var type1" id="S32T89U210">obsidx</span>)</span>&gt;=<span class="mxinfo " id="T5:U154">1</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">            <span class="mxinfo " id="T5:U155"><span class="mxinfo " id="T5:U156"><span class="var type1" id="S29T27U215">minradius</span>(<span class="var type1" id="S31T5U216">ii</span>)</span> = <span class="mxinfo " id="T5:U159">min(<span class="mxinfo " id="T90:U160"><span class="var type1" id="S24T2U220">dist2target</span>(<span class="var type1" id="S32T89U221">obsidx</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">            <span class="mxinfo " id="T101:U163"><span class="mxinfo " id="T101:U164"><span class="var type1" id="S30T2U225">cvistmp</span>(<span class="mxinfo " id="T102:U166"><span class="mxinfo " id="T102:U167"><span class="mxinfo " id="T101:U168"><span class="var type1" id="S24T2U229">dist2target</span>(:)</span>&gt;= <span class="mxinfo " id="T5:U170"><span class="var type1" id="S29T27U232">minradius</span>(<span class="var type1" id="S31T5U233">ii</span>)</span></span> &amp; <span class="mxinfo " id="T102:U173"><span class="mxinfo " id="T101:U174"><span class="var type1" id="S25T2U236">angle2target</span>(:)</span>==<span class="var type1" id="S31T5U238">ii</span></span></span>)</span>=<span class="mxinfo " id="T5:U177">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">        <span class="mxinfo " id="T2:U178"><span class="mxinfo " id="T2:U179"><span class="var type1" id="S20T86U243">ccdp_cvis</span>(<span class="mxinfo " id="T103:U181">:</span>,<span class="mxinfo " id="T103:U182">:</span>,<span class="mxinfo " id="T5:U183"><span class="var type1" id="S23T5U247">tt</span>+<span class="mxinfo " id="T5:U185">1</span></span>)</span> = <span class="var type1" id="S30T2U249">cvistmp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">       <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="comment">% -- [ Cost: Ctrack ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">   <span class="comment">% sensing region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S31T5U252">ii</span>=<span class="mxinfo " id="T5:U188">1</span>:<span class="var type1" id="S17T5U255">ndir</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">        <span class="comment">%ccdp.ctrack(tt+1).val(:,:,ii) = reshape(sum(1-normcdf(bsxfun(@plus,costparam.A(:,:,ii)*[ccdp.xs(:)-pEst(tt).mean(1),ccdp.ys(:)-pEst(tt).mean(2)]',costparam.cc)/pEst(tt).sig),1) &gt; threshold_track,[rlen,clen]);% matrix of normal vectors of sensing region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">        <span class="mxinfo " id="T2:U190"><span class="mxinfo " id="T2:U191"><span class="var type1" id="S18T85U259">ccdp_ctrack</span>(<span class="mxinfo " id="T103:U193">:</span>,<span class="mxinfo " id="T103:U194">:</span>,<span class="var type1" id="S31T5U262">ii</span>,<span class="mxinfo " id="T5:U196"><span class="var type1" id="S23T5U264">tt</span>+<span class="mxinfo " id="T5:U198">1</span></span>)</span> =  <span class="mxinfo " id="T88:U199">reshape(<span class="mxinfo " id="T94:U200"><span class="mxinfo " id="T93:U201">sum(<span class="mxinfo " id="T92:U202"><span class="mxinfo " id="T5:U203">1</span>-<span class="mxinfo " id="T92:U204">normcdf(<span class="mxinfo " id="T92:U205"><span class="mxinfo " id="T92:U206">bsxfun(@plus,<span class="mxinfo " id="T92:U207"><span class="mxinfo " id="T28:U208"><span class="mxinfo " id="T9:U209"><span class="var type1" id="S11T7U283">costparam</span>.A</span>(<span class="mxinfo " id="T104:U211">:</span>,<span class="mxinfo " id="T69:U212">:</span>,<span class="var type1" id="S31T5U287">ii</span>)</span>*<span class="mxinfo " id="T91:U214"><span class="mxinfo " id="T105:U215">[<span class="mxinfo " id="T101:U216"><span class="mxinfo " id="T2:U217"><span class="var type1" id="S9T1U294">ccdp</span>.xs</span>(:)-<span class="mxinfo " id="T5:U219"><span class="mxinfo " id="T11:U220"><span class="mxinfo " id="T100:U221"><span class="var type1" id="S6T10U300">pEst</span>(<span class="var type1" id="S23T5U301">tt</span>)</span>.mean</span>(<span class="mxinfo " id="T5:U224">1</span>)</span></span>,<span class="mxinfo " id="T101:U225"><span class="mxinfo " id="T2:U226"><span class="var type1" id="S9T1U307">ccdp</span>.ys</span>(:)-<span class="mxinfo " id="T5:U228"><span class="mxinfo " id="T11:U229"><span class="mxinfo " id="T100:U230"><span class="var type1" id="S6T10U313">pEst</span>(<span class="var type1" id="S23T5U314">tt</span>)</span>.mean</span>(<span class="mxinfo " id="T5:U233">2</span>)</span></span>]</span>'</span></span>,<span class="mxinfo " id="T8:U234"><span class="var type1" id="S11T7U318">costparam</span>.cc</span>)</span>/<span class="mxinfo " id="T5:U236"><span class="mxinfo " id="T100:U237"><span class="var type1" id="S6T10U322">pEst</span>(<span class="var type1" id="S23T5U323">tt</span>)</span>.sig</span></span>)</span></span>,1)</span> &gt; <span class="var type1" id="S10T5U326">threshold_track</span></span>,<span class="mxinfo " id="T25:U241">[<span class="var type1" id="S14T5U329">rlen</span>,<span class="var type1" id="S15T5U330">clen</span>]</span>)</span></span>;<span class="comment">% matrix of normal vectors of sensing region</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">     <span class="comment">% -- [Cost: Cavoid ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="mxinfo " id="T5:U244"><span class="var type1" id="S39T5U333">Rfree</span> = <span class="mxinfo " id="T5:U246">2</span></span>; <span class="comment">% probability of collision is determined by Rfree</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">    <span class="mxinfo " id="T2:U247"><span class="mxinfo " id="T2:U248"><span class="var type1" id="S21T86U338">ccdp_cavoid</span>(<span class="mxinfo " id="T103:U250">:</span>,<span class="mxinfo " id="T103:U251">:</span>,<span class="mxinfo " id="T5:U252"><span class="var type1" id="S23T5U342">tt</span>+<span class="mxinfo " id="T5:U254">1</span></span>)</span> = <span class="mxinfo " id="T6:U255"><span class="mxinfo " id="T95:U256">conv2(<span class="mxinfo " id="T95:U257">double(<span class="mxinfo " id="T6:U258"><span class="var type1" id="S9T1U350">ccdp</span>.gmap</span>)</span>,ones(<span class="var type1" id="S39T5U356">Rfree</span>*2+1),<span class="string">'same'</span>)</span>&gt;=<span class="mxinfo " id="T5:U261">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">    <span class="comment">% -- [ value of constraint ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">    <span class="comment">%ccdp.cconst(tt+1).val = bsxfun(@or,ccdp.ctrack(tt+1).val,ccdp.cavoid(:,:,tt+1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">    <span class="mxinfo " id="T86:U262"><span class="mxinfo " id="T86:U263"><span class="var type1" id="S22T85U364">ccdp_cconst</span>(<span class="mxinfo " id="T103:U265">:</span>,<span class="mxinfo " id="T103:U266">:</span>,<span class="mxinfo " id="T104:U267">:</span>,<span class="mxinfo " id="T5:U268"><span class="var type1" id="S23T5U369">tt</span>+<span class="mxinfo " id="T5:U270">1</span></span>)</span>= <span class="mxinfo " id="T96:U271">bsxfun(@or,<span class="mxinfo " id="T86:U272"><span class="var type1" id="S18T85U376">ccdp_ctrack</span>(<span class="mxinfo " id="T103:U274">:</span>,<span class="mxinfo " id="T103:U275">:</span>,<span class="mxinfo " id="T104:U276">:</span>,<span class="mxinfo " id="T5:U277"><span class="var type1" id="S23T5U381">tt</span>+<span class="mxinfo " id="T5:U279">1</span></span>)</span>,<span class="mxinfo " id="T2:U280"><span class="var type1" id="S21T86U384">ccdp_cavoid</span>(<span class="mxinfo " id="T103:U282">:</span>,<span class="mxinfo " id="T103:U283">:</span>,<span class="mxinfo " id="T5:U284"><span class="var type1" id="S23T5U388">tt</span>+<span class="mxinfo " id="T5:U286">1</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="comment">% -- [ Backward recursion ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">% find the optimal control when lambda is given</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="mxinfo " id="T5:U287"><span class="var type1" id="S44T5U392">lagcoeff</span> = <span class="mxinfo " id="T5:U289">0</span></span>; <span class="comment">%lagrangian coefficient</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="mxinfo " id="T25:U290"><span class="var type1" id="S45T25U396">lagrng</span> = <span class="mxinfo " id="T25:U292">[<span class="mxinfo " id="T5:U293">0</span>,<span class="mxinfo " id="T5:U294">1</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="mxinfo " id="T5:U295"><span class="var type1" id="S46T5U403">lag_feas</span>=<span class="mxinfo " id="T5:U297">1</span></span>; <span class="comment">% use to check the feasibility</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="mxinfo " id="T5:U298"><span class="var type1" id="S47T5U407">flag_converge</span> = <span class="mxinfo " id="T5:U300">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S48T5U411">ilagran</span> = <span class="mxinfo " id="T5:U302">1</span>:100</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    <span class="comment">% initialize the optimal control: 'col': current column+col,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="comment">% 'row': current row+'row',   dirs: replace current dirs with dirs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    <span class="mxinfo " id="T85:U303"><span class="var type1" id="S49T85U417">Optctrl_row</span> = <span class="mxinfo " id="T85:U305">zeros(<span class="var type1" id="S14T5U420">rlen</span>,<span class="var type1" id="S15T5U421">clen</span>,<span class="var type1" id="S17T5U422">ndir</span>,<span class="var type1" id="S7T5U423">H</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="mxinfo " id="T85:U310"><span class="var type1" id="S50T85U426">Optctrl_col</span> = <span class="mxinfo " id="T85:U312">zeros(<span class="var type1" id="S14T5U429">rlen</span>,<span class="var type1" id="S15T5U430">clen</span>,<span class="var type1" id="S17T5U431">ndir</span>,<span class="var type1" id="S7T5U432">H</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T85:U317"><span class="var type1" id="S51T85U435">Optctrl_dirs</span> = <span class="mxinfo " id="T85:U319">zeros(<span class="var type1" id="S14T5U438">rlen</span>,<span class="var type1" id="S15T5U439">clen</span>,<span class="var type1" id="S17T5U440">ndir</span>,<span class="var type1" id="S7T5U441">H</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    <span class="mxinfo " id="T85:U324"><span class="var type1" id="S52T85U444">Jmin</span> = <span class="mxinfo " id="T85:U326"><span class="mxinfo " id="T5:U327">100</span>*<span class="mxinfo " id="T85:U328">ones(<span class="mxinfo " id="T106:U329">[<span class="var type1" id="S14T5U451">rlen</span>,<span class="var type1" id="S15T5U452">clen</span>,<span class="var type1" id="S17T5U453">ndir</span>,<span class="mxinfo " id="T5:U333"><span class="var type1" id="S7T5U455">H</span>+<span class="mxinfo " id="T5:U335">1</span></span>]</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="mxinfo " id="T86:U336"><span class="mxinfo " id="T86:U337"><span class="var type1" id="S52T85U460">Jmin</span>(<span class="mxinfo " id="T103:U339">:</span>,<span class="mxinfo " id="T103:U340">:</span>,<span class="mxinfo " id="T104:U341">:</span>,<span class="mxinfo " id="T5:U342"><span class="var type1" id="S7T5U465">H</span>+<span class="mxinfo " id="T5:U344">1</span></span>)</span> =  <span class="mxinfo " id="T86:U345">bsxfun(@plus, <span class="mxinfo " id="T86:U346"><span class="var type1" id="S44T5U472">lagcoeff</span>*<span class="mxinfo " id="T86:U348"><span class="var type1" id="S22T85U474">ccdp_cconst</span>(<span class="mxinfo " id="T103:U350">:</span>,<span class="mxinfo " id="T103:U351">:</span>,<span class="mxinfo " id="T104:U352">:</span>,<span class="mxinfo " id="T5:U353"><span class="var type1" id="S7T5U479">H</span>+<span class="mxinfo " id="T5:U355">1</span></span>)</span></span>, <span class="mxinfo " id="T2:U356"><span class="var type1" id="S46T5U482">lag_feas</span>*<span class="mxinfo " id="T2:U358"><span class="var type1" id="S20T86U484">ccdp_cvis</span>(<span class="mxinfo " id="T103:U360">:</span>,<span class="mxinfo " id="T103:U361">:</span>,<span class="mxinfo " id="T5:U362"><span class="var type1" id="S7T5U488">H</span>+<span class="mxinfo " id="T5:U364">1</span></span>)</span></span>)</span></span>; <span class="comment">%Value: Cvis + lambda * Ctrack</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="comment">%Optctrl(1:H)=struct('row',zeros([rlen,clen,ndir]),'col',zeros([rlen,clen,ndir]),'dirs',zeros([rlen,clen,ndir]));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">    <span class="comment">%Jmin(1:H+1) = struct('Jmin',100*ones([rlen,clen,ndir]));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">    <span class="comment">%Jmin(H+1).Jmin = bsxfun(@plus, lagcoeff*ccdp.cconst(H+1).val, lag_feas*ccdp.cvis(:,:,H+1)); %Value: Cvis + lambda * Ctrack</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S23T5U492">tt</span>=<span class="var type1" id="S7T5U495">H</span>:<span class="mxinfo " id="T5:U367">-1</span>:<span class="mxinfo " id="T5:U368">1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="comment">% lagrangian - onestep</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">        <span class="mxinfo " id="T86:U369"><span class="var type1" id="S53T86U501">Lk</span> = <span class="mxinfo " id="T86:U371">bsxfun(@plus, <span class="mxinfo " id="T86:U372"><span class="var type1" id="S44T5U507">lagcoeff</span>*<span class="mxinfo " id="T86:U374"><span class="var type1" id="S22T85U509">ccdp_cconst</span>(<span class="mxinfo " id="T103:U376">:</span>,<span class="mxinfo " id="T103:U377">:</span>,<span class="mxinfo " id="T104:U378">:</span>,<span class="var type1" id="S23T5U513">tt</span>)</span></span>, <span class="mxinfo " id="T2:U380"><span class="var type1" id="S46T5U515">lag_feas</span>*<span class="mxinfo " id="T2:U382"><span class="var type1" id="S20T86U517">ccdp_cvis</span>(<span class="mxinfo " id="T103:U384">:</span>,<span class="mxinfo " id="T103:U385">:</span>,<span class="var type1" id="S23T5U520">tt</span>)</span></span>)</span></span>; <span class="comment">%Value: Cvis + lambda * Ctrack</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S31T5U523">ii</span>=<span class="mxinfo " id="T5:U388">1</span>:<span class="var type1" id="S17T5U526">ndir</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">            [<span class="mxinfo " id="T2:U390"><span class="var type1" id="S54T2U530">Jmin_dir</span></span>,<span class="mxinfo " id="T2:U392"><span class="var type1" id="S55T2U531">mindiridx</span></span>] = min(<span class="mxinfo " id="T86:U394"><span class="var type1" id="S52T85U535">Jmin</span>(<span class="mxinfo " id="T103:U396">:</span>,<span class="mxinfo " id="T103:U397">:</span>,<span class="mxinfo " id="T55:U398"><span class="mxinfo " id="T107:U399"><span class="var type1" id="S12T70U540">nextstate</span>(<span class="var type1" id="S31T5U541">ii</span>)</span>.dir</span>,<span class="mxinfo " id="T5:U402"><span class="var type1" id="S23T5U544">tt</span>+<span class="mxinfo " id="T5:U404">1</span></span>)</span>,[],3); </span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">            <span class="mxinfo " id="T2:U405"><span class="var type1" id="S55T2U551">mindiridx</span> = <span class="mxinfo " id="T2:U407"><span class="mxinfo " id="T55:U408"><span class="mxinfo " id="T107:U409"><span class="var type1" id="S12T70U555">nextstate</span>(<span class="var type1" id="S31T5U556">ii</span>)</span>.dir</span>(<span class="var type1" id="S55T2U558">mindiridx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">            <span class="comment">% find the optimal control-onestep</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">            <span class="keyword">for</span> <span class="var type1" id="S56T5U561">jj</span>= <span class="mxinfo " id="T5:U414">1</span>:<span class="mxinfo " id="T5:U415">size(<span class="mxinfo " id="T28:U416"><span class="mxinfo " id="T107:U417"><span class="var type1" id="S12T70U568">nextstate</span>(<span class="var type1" id="S31T5U569">ii</span>)</span>.sidxs</span>,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">                <span class="mxinfo " id="T87:U420"><span class="var type1" id="S57T87U574">original_rng_r</span> = <span class="mxinfo " id="T87:U422"><span class="mxinfo " id="T5:U423">max(<span class="mxinfo " id="T5:U424">1</span>,<span class="mxinfo " id="T5:U425"><span class="mxinfo " id="T5:U426">1</span>-<span class="mxinfo " id="T5:U427"><span class="mxinfo " id="T28:U428"><span class="mxinfo " id="T107:U429"><span class="var type1" id="S12T70U584">nextstate</span>(<span class="var type1" id="S31T5U585">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U587">jj</span>,<span class="mxinfo " id="T15:U433">1</span>)</span></span>)</span>:<span class="mxinfo " id="T5:U434">min(<span class="var type1" id="S14T5U591">rlen</span>,<span class="mxinfo " id="T5:U436"><span class="var type1" id="S14T5U593">rlen</span>-<span class="mxinfo " id="T5:U438"><span class="mxinfo " id="T28:U439"><span class="mxinfo " id="T107:U440"><span class="var type1" id="S12T70U597">nextstate</span>(<span class="var type1" id="S31T5U598">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U600">jj</span>,<span class="mxinfo " id="T5:U444">1</span>)</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">                <span class="mxinfo " id="T87:U445"><span class="var type1" id="S59T87U604">original_rng_c</span> = <span class="mxinfo " id="T87:U447"><span class="mxinfo " id="T5:U448">max(<span class="mxinfo " id="T5:U449">1</span>,<span class="mxinfo " id="T5:U450"><span class="mxinfo " id="T5:U451">1</span>-<span class="mxinfo " id="T5:U452"><span class="mxinfo " id="T28:U453"><span class="mxinfo " id="T107:U454"><span class="var type1" id="S12T70U614">nextstate</span>(<span class="var type1" id="S31T5U615">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U617">jj</span>,<span class="mxinfo " id="T15:U458">2</span>)</span></span>)</span>:<span class="mxinfo " id="T5:U459">min(<span class="var type1" id="S15T5U621">clen</span>,<span class="mxinfo " id="T5:U461"><span class="var type1" id="S15T5U623">clen</span>-<span class="mxinfo " id="T5:U463"><span class="mxinfo " id="T28:U464"><span class="mxinfo " id="T107:U465"><span class="var type1" id="S12T70U627">nextstate</span>(<span class="var type1" id="S31T5U628">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U630">jj</span>,<span class="mxinfo " id="T5:U469">2</span>)</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">                <span class="mxinfo " id="T87:U470"><span class="var type1" id="S60T87U634">comp_rng_r</span> = <span class="mxinfo " id="T87:U472"><span class="mxinfo " id="T5:U473">max(<span class="mxinfo " id="T5:U474">1</span>,<span class="mxinfo " id="T5:U475"><span class="mxinfo " id="T5:U476">1</span>+<span class="mxinfo " id="T5:U477"><span class="mxinfo " id="T28:U478"><span class="mxinfo " id="T107:U479"><span class="var type1" id="S12T70U644">nextstate</span>(<span class="var type1" id="S31T5U645">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U647">jj</span>,<span class="mxinfo " id="T15:U483">1</span>)</span></span>)</span>:<span class="mxinfo " id="T5:U484">min(<span class="var type1" id="S14T5U651">rlen</span>,<span class="mxinfo " id="T5:U486"><span class="var type1" id="S14T5U653">rlen</span>+<span class="mxinfo " id="T5:U488"><span class="mxinfo " id="T28:U489"><span class="mxinfo " id="T107:U490"><span class="var type1" id="S12T70U657">nextstate</span>(<span class="var type1" id="S31T5U658">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U660">jj</span>,<span class="mxinfo " id="T5:U494">1</span>)</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">                <span class="mxinfo " id="T87:U495"><span class="var type1" id="S61T87U664">comp_rng_c</span> = <span class="mxinfo " id="T87:U497"><span class="mxinfo " id="T5:U498">max(<span class="mxinfo " id="T5:U499">1</span>,<span class="mxinfo " id="T5:U500"><span class="mxinfo " id="T5:U501">1</span>+<span class="mxinfo " id="T5:U502"><span class="mxinfo " id="T28:U503"><span class="mxinfo " id="T107:U504"><span class="var type1" id="S12T70U674">nextstate</span>(<span class="var type1" id="S31T5U675">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U677">jj</span>,<span class="mxinfo " id="T15:U508">2</span>)</span></span>)</span>:<span class="mxinfo " id="T5:U509">min(<span class="var type1" id="S15T5U681">clen</span>,<span class="mxinfo " id="T5:U511"><span class="var type1" id="S15T5U683">clen</span>+<span class="mxinfo " id="T5:U513"><span class="mxinfo " id="T28:U514"><span class="mxinfo " id="T107:U515"><span class="var type1" id="S12T70U687">nextstate</span>(<span class="var type1" id="S31T5U688">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U690">jj</span>,<span class="mxinfo " id="T5:U519">2</span>)</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">                <span class="comment">% compare two matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">                 <span class="mxinfo " id="T88:U520"><span class="var type1" id="S62T88U694">CompMat</span> = <span class="mxinfo " id="T88:U522">(<span class="mxinfo " id="T88:U523"><span class="mxinfo " id="T2:U524"><span class="var type1" id="S52T85U699">Jmin</span>(<span class="var type1" id="S57T87U700">original_rng_r</span>,<span class="var type1" id="S59T87U701">original_rng_c</span>,<span class="var type1" id="S31T5U702">ii</span>,<span class="var type1" id="S23T5U703">tt</span>)</span>  &gt;  <span class="mxinfo " id="T2:U530"><span class="var type1" id="S54T2U705">Jmin_dir</span>(<span class="var type1" id="S60T87U706">comp_rng_r</span>,<span class="var type1" id="S61T87U707">comp_rng_c</span>)</span></span>) |<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="mxinfo " id="T88:U520"><span class="mxinfo " id="T88:U522">                     (<span class="mxinfo " id="T88:U534"><span class="mxinfo " id="T88:U535"><span class="mxinfo " id="T2:U536"><span class="var type1" id="S52T85U712">Jmin</span>(<span class="var type1" id="S57T87U713">original_rng_r</span>,<span class="var type1" id="S59T87U714">original_rng_c</span>,<span class="var type1" id="S31T5U715">ii</span>,<span class="var type1" id="S23T5U716">tt</span>)</span>==<span class="mxinfo " id="T2:U542"><span class="var type1" id="S54T2U718">Jmin_dir</span>(<span class="var type1" id="S60T87U719">comp_rng_r</span>,<span class="var type1" id="S61T87U720">comp_rng_c</span>)</span></span> &amp; <span class="mxinfo " id="T88:U546"><span class="mxinfo " id="T2:U547">abs(<span class="mxinfo " id="T2:U548"><span class="var type1" id="S51T85U725">Optctrl_dirs</span>(<span class="var type1" id="S57T87U726">original_rng_r</span>,<span class="var type1" id="S59T87U727">original_rng_c</span>,<span class="var type1" id="S31T5U728">ii</span>,<span class="var type1" id="S23T5U729">tt</span>)</span>)</span>&gt;<span class="mxinfo " id="T2:U554">abs(<span class="mxinfo " id="T2:U555"><span class="var type1" id="S55T2U733">mindiridx</span>(<span class="var type1" id="S60T87U734">comp_rng_r</span>,<span class="var type1" id="S61T87U735">comp_rng_c</span>)</span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">                <span class="comment">% update Jmin</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">                 <span class="mxinfo " id="T2:U559"><span class="mxinfo " id="T2:U560"><span class="var type1" id="S52T85U739">Jmin</span>(<span class="var type1" id="S57T87U740">original_rng_r</span>,<span class="var type1" id="S59T87U741">original_rng_c</span>,<span class="var type1" id="S31T5U742">ii</span>,<span class="var type1" id="S23T5U743">tt</span>)</span>  = <span class="mxinfo " id="T2:U566"><span class="mxinfo " id="T2:U567">(<span class="mxinfo " id="T2:U568"><span class="mxinfo " id="T5:U569">1</span>-<span class="var type1" id="S62T88U749">CompMat</span></span>).*<span class="mxinfo " id="T2:U571"><span class="var type1" id="S52T85U751">Jmin</span>(<span class="var type1" id="S57T87U752">original_rng_r</span>,<span class="var type1" id="S59T87U753">original_rng_c</span>,<span class="var type1" id="S31T5U754">ii</span>,<span class="var type1" id="S23T5U755">tt</span>)</span></span> + <span class="mxinfo " id="T2:U577"><span class="var type1" id="S62T88U757">CompMat</span>.* <span class="mxinfo " id="T2:U579"><span class="var type1" id="S54T2U759">Jmin_dir</span>(<span class="var type1" id="S60T87U760">comp_rng_r</span>,<span class="var type1" id="S61T87U761">comp_rng_c</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">                <span class="comment">% update optimal control</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">                <span class="mxinfo " id="T2:U583"><span class="mxinfo " id="T2:U584"><span class="var type1" id="S49T85U765">Optctrl_row</span>(<span class="var type1" id="S57T87U766">original_rng_r</span>,<span class="var type1" id="S59T87U767">original_rng_c</span>,<span class="var type1" id="S31T5U768">ii</span>,<span class="var type1" id="S23T5U769">tt</span>)</span> =  <span class="mxinfo " id="T2:U590"><span class="mxinfo " id="T2:U591">(<span class="mxinfo " id="T88:U592">~<span class="var type1" id="S62T88U774">CompMat</span></span>).*<span class="mxinfo " id="T2:U594"><span class="var type1" id="S49T85U776">Optctrl_row</span>(<span class="var type1" id="S57T87U777">original_rng_r</span>,<span class="var type1" id="S59T87U778">original_rng_c</span>,<span class="var type1" id="S31T5U779">ii</span>,<span class="var type1" id="S23T5U780">tt</span>)</span></span> + <span class="mxinfo " id="T2:U600"><span class="var type1" id="S62T88U782">CompMat</span>.*<span class="mxinfo " id="T5:U602"><span class="mxinfo " id="T28:U603"><span class="mxinfo " id="T107:U604"><span class="var type1" id="S12T70U786">nextstate</span>(<span class="var type1" id="S31T5U787">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U789">jj</span>,<span class="mxinfo " id="T5:U608">1</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">                <span class="mxinfo " id="T2:U609"><span class="mxinfo " id="T2:U610"><span class="var type1" id="S50T85U794">Optctrl_col</span>(<span class="var type1" id="S57T87U795">original_rng_r</span>,<span class="var type1" id="S59T87U796">original_rng_c</span>,<span class="var type1" id="S31T5U797">ii</span>,<span class="var type1" id="S23T5U798">tt</span>)</span> =  <span class="mxinfo " id="T2:U616"><span class="mxinfo " id="T2:U617">(<span class="mxinfo " id="T88:U618">~<span class="var type1" id="S62T88U803">CompMat</span></span>).*<span class="mxinfo " id="T2:U620"><span class="var type1" id="S50T85U805">Optctrl_col</span>(<span class="var type1" id="S57T87U806">original_rng_r</span>,<span class="var type1" id="S59T87U807">original_rng_c</span>,<span class="var type1" id="S31T5U808">ii</span>,<span class="var type1" id="S23T5U809">tt</span>)</span></span> + <span class="mxinfo " id="T2:U626"><span class="var type1" id="S62T88U811">CompMat</span>.*<span class="mxinfo " id="T5:U628"><span class="mxinfo " id="T28:U629"><span class="mxinfo " id="T107:U630"><span class="var type1" id="S12T70U815">nextstate</span>(<span class="var type1" id="S31T5U816">ii</span>)</span>.sidxs</span>(<span class="var type1" id="S56T5U818">jj</span>,<span class="mxinfo " id="T5:U634">2</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">                <span class="mxinfo " id="T2:U635"><span class="mxinfo " id="T2:U636"><span class="var type1" id="S51T85U823">Optctrl_dirs</span>(<span class="var type1" id="S57T87U824">original_rng_r</span>,<span class="var type1" id="S59T87U825">original_rng_c</span>,<span class="var type1" id="S31T5U826">ii</span>,<span class="var type1" id="S23T5U827">tt</span>)</span> =  <span class="mxinfo " id="T2:U642"><span class="mxinfo " id="T2:U643">(<span class="mxinfo " id="T88:U644">~<span class="var type1" id="S62T88U832">CompMat</span></span>).*<span class="mxinfo " id="T2:U646"><span class="var type1" id="S51T85U834">Optctrl_dirs</span>(<span class="var type1" id="S57T87U835">original_rng_r</span>,<span class="var type1" id="S59T87U836">original_rng_c</span>,<span class="var type1" id="S31T5U837">ii</span>,<span class="var type1" id="S23T5U838">tt</span>)</span></span> + <span class="mxinfo " id="T2:U652"><span class="var type1" id="S62T88U840">CompMat</span>.*<span class="mxinfo " id="T2:U654"><span class="var type1" id="S55T2U842">mindiridx</span>(<span class="var type1" id="S60T87U843">comp_rng_r</span>,<span class="var type1" id="S61T87U844">comp_rng_c</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">        <span class="comment">%Jmin(tt).Jmin=Jmin(tt).Jmin + Lk;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">        <span class="mxinfo " id="T86:U658"><span class="mxinfo " id="T86:U659"><span class="var type1" id="S52T85U848">Jmin</span>(<span class="mxinfo " id="T103:U661">:</span>,<span class="mxinfo " id="T103:U662">:</span>,<span class="mxinfo " id="T104:U663">:</span>,<span class="var type1" id="S23T5U852">tt</span>)</span>=<span class="mxinfo " id="T86:U665"><span class="mxinfo " id="T86:U666"><span class="var type1" id="S52T85U855">Jmin</span>(<span class="mxinfo " id="T103:U668">:</span>,<span class="mxinfo " id="T103:U669">:</span>,<span class="mxinfo " id="T104:U670">:</span>,<span class="var type1" id="S23T5U859">tt</span>)</span> + <span class="var type1" id="S53T86U860">Lk</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    <span class="comment">% -- [ Find the optimal control ] -- %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">    <span class="mxinfo " id="T76:U673"><span class="var type1" id="S64T76U863">currs_idx</span> = <span class="mxinfo " id="T76:U675">zeros(<span class="mxinfo " id="T5:U676">3</span>,<span class="mxinfo " id="T5:U677"><span class="var type1" id="S7T5U868">H</span>+<span class="mxinfo " id="T5:U679">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="mxinfo " id="T75:U680"><span class="mxinfo " id="T75:U681"><span class="var type1" id="S64T76U873">currs_idx</span>(<span class="mxinfo " id="T73:U683">:</span>,<span class="mxinfo " id="T5:U684">1</span>)</span> = <span class="mxinfo " id="T75:U685">[<span class="mxinfo " id="T84:U686"><span class="mxinfo " id="T84:U687"><span class="mxinfo " id="T25:U688">round(<span class="mxinfo " id="T25:U689"><span class="mxinfo " id="T25:U690">[<span class="mxinfo " id="T5:U691"><span class="mxinfo " id="T5:U692"><span class="var type1" id="S5T75U887">pS</span>(2)</span>-<span class="mxinfo " id="T5:U694"><span class="mxinfo " id="T2:U695"><span class="var type1" id="S9T1U891">ccdp</span>.ys</span>(<span class="mxinfo " id="T5:U697">1</span>)</span></span>,<span class="mxinfo " id="T5:U698"><span class="mxinfo " id="T5:U699"><span class="var type1" id="S5T75U896">pS</span>(1)</span>-<span class="mxinfo " id="T5:U701"><span class="mxinfo " id="T2:U702"><span class="var type1" id="S9T1U900">ccdp</span>.xs</span>(<span class="mxinfo " id="T5:U704">1</span>)</span></span>]</span>/<span class="mxinfo " id="T5:U705"><span class="var type1" id="S9T1U904">ccdp</span>.glen</span></span>)</span>'</span>+<span class="mxinfo " id="T5:U707">1</span></span>; <span class="mxinfo " id="T5:U708"><span class="mxinfo " id="T5:U709">mod(<span class="mxinfo " id="T5:U710">round(<span class="mxinfo " id="T5:U711"><span class="mxinfo " id="T5:U712"><span class="mxinfo " id="T5:U713"><span class="mxinfo " id="T5:U714"><span class="var type1" id="S5T75U917">pS</span>(3)</span>/<span class="mxinfo " id="T5:U716">2</span></span>/<span class="mxinfo " id="T5:U717">pi</span></span>*<span class="var type1" id="S17T5U922">ndir</span></span>)</span>,<span class="var type1" id="S17T5U923">ndir</span>)</span>+<span class="mxinfo " id="T5:U720">1</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo " id="T5:U721"><span class="var type1" id="S66T5U927">const_val</span> = <span class="mxinfo " id="T5:U723">0</span></span>; <span class="comment">% number of violations of constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="mxinfo " id="T76:U724"><span class="var type1" id="S67T76U931">optidx</span> = <span class="mxinfo " id="T76:U726">zeros(<span class="mxinfo " id="T5:U727">3</span>,<span class="var type1" id="S7T5U935">H</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S23T5U938">tt</span>=<span class="mxinfo " id="T5:U730">1</span>:<span class="var type1" id="S7T5U941">H</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">        <span class="mxinfo " id="T75:U732"><span class="mxinfo " id="T75:U733"><span class="var type1" id="S67T76U945">optidx</span>(<span class="mxinfo " id="T73:U735">:</span>,<span class="var type1" id="S23T5U947">tt</span>)</span> = <span class="mxinfo " id="T75:U737"><span class="mxinfo " id="T72:U738">[<span class="mxinfo " id="T5:U739"><span class="var type1" id="S49T85U952">Optctrl_row</span>(<span class="mxinfo " id="T5:U741"><span class="var type1" id="S64T76U954">currs_idx</span>(<span class="mxinfo " id="T15:U743">1</span>,<span class="var type1" id="S23T5U956">tt</span>)</span>,<span class="mxinfo " id="T5:U745"><span class="var type1" id="S64T76U958">currs_idx</span>(<span class="mxinfo " id="T15:U747">2</span>,<span class="var type1" id="S23T5U960">tt</span>)</span>,<span class="mxinfo " id="T5:U749"><span class="var type1" id="S64T76U962">currs_idx</span>(<span class="mxinfo " id="T15:U751">3</span>,<span class="var type1" id="S23T5U964">tt</span>)</span>,<span class="var type1" id="S23T5U965">tt</span>)</span>,<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="mxinfo " id="T75:U732"><span class="mxinfo " id="T75:U737"><span class="mxinfo " id="T72:U738">            <span class="mxinfo " id="T5:U754"><span class="var type1" id="S50T85U967">Optctrl_col</span>(<span class="mxinfo " id="T5:U756"><span class="var type1" id="S64T76U969">currs_idx</span>(<span class="mxinfo " id="T15:U758">1</span>,<span class="var type1" id="S23T5U971">tt</span>)</span>,<span class="mxinfo " id="T5:U760"><span class="var type1" id="S64T76U973">currs_idx</span>(<span class="mxinfo " id="T15:U762">2</span>,<span class="var type1" id="S23T5U975">tt</span>)</span>,<span class="mxinfo " id="T5:U764"><span class="var type1" id="S64T76U977">currs_idx</span>(<span class="mxinfo " id="T15:U766">3</span>,<span class="var type1" id="S23T5U979">tt</span>)</span>,<span class="var type1" id="S23T5U980">tt</span>)</span>,<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"><span class="mxinfo " id="T75:U732"><span class="mxinfo " id="T75:U737"><span class="mxinfo " id="T72:U738">            <span class="mxinfo " id="T5:U769"><span class="var type1" id="S51T85U982">Optctrl_dirs</span>(<span class="mxinfo " id="T5:U771"><span class="var type1" id="S64T76U984">currs_idx</span>(<span class="mxinfo " id="T15:U773">1</span>,<span class="var type1" id="S23T5U986">tt</span>)</span>,<span class="mxinfo " id="T5:U775"><span class="var type1" id="S64T76U988">currs_idx</span>(<span class="mxinfo " id="T15:U777">2</span>,<span class="var type1" id="S23T5U990">tt</span>)</span>,<span class="mxinfo " id="T5:U779"><span class="var type1" id="S64T76U992">currs_idx</span>(<span class="mxinfo " id="T15:U781">3</span>,<span class="var type1" id="S23T5U994">tt</span>)</span>,<span class="var type1" id="S23T5U995">tt</span>)</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">        <span class="mxinfo " id="T84:U784"><span class="mxinfo " id="T84:U785"><span class="var type1" id="S64T76U999">currs_idx</span>(<span class="mxinfo " id="T25:U787"><span class="mxinfo " id="T5:U788">1</span>:<span class="mxinfo " id="T5:U789">2</span></span>,<span class="mxinfo " id="T5:U790"><span class="var type1" id="S23T5U1004">tt</span>+<span class="mxinfo " id="T5:U792">1</span></span>)</span> = <span class="mxinfo " id="T84:U793"><span class="mxinfo " id="T84:U794"><span class="var type1" id="S64T76U1008">currs_idx</span>(<span class="mxinfo " id="T25:U796"><span class="mxinfo " id="T5:U797">1</span>:<span class="mxinfo " id="T5:U798">2</span></span>,<span class="var type1" id="S23T5U1012">tt</span>)</span>+<span class="mxinfo " id="T84:U800"><span class="var type1" id="S67T76U1014">optidx</span>(<span class="mxinfo " id="T25:U802"><span class="mxinfo " id="T5:U803">1</span>:<span class="mxinfo " id="T5:U804">2</span></span>,<span class="var type1" id="S23T5U1018">tt</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">        <span class="mxinfo " id="T5:U806"><span class="mxinfo " id="T5:U807"><span class="var type1" id="S64T76U1022">currs_idx</span>(<span class="mxinfo " id="T15:U809">3</span>,<span class="mxinfo " id="T5:U810"><span class="var type1" id="S23T5U1025">tt</span>+<span class="mxinfo " id="T5:U812">1</span></span>)</span> = <span class="mxinfo " id="T5:U813"><span class="var type1" id="S67T76U1028">optidx</span>(<span class="mxinfo " id="T5:U815">3</span>,<span class="var type1" id="S23T5U1030">tt</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">        <span class="mxinfo " id="T5:U817"><span class="var type1" id="S66T5U1033">const_val</span> = <span class="mxinfo " id="T5:U819"><span class="var type1" id="S66T5U1035">const_val</span> + <span class="mxinfo " id="T5:U821"><span class="var type1" id="S22T85U1037">ccdp_cconst</span>(<span class="mxinfo " id="T5:U823"><span class="var type1" id="S64T76U1039">currs_idx</span>(<span class="mxinfo " id="T15:U825">1</span>,<span class="mxinfo " id="T5:U826"><span class="var type1" id="S23T5U1042">tt</span>+<span class="mxinfo " id="T5:U828">1</span></span>)</span>,<span class="mxinfo " id="T5:U829"><span class="var type1" id="S64T76U1045">currs_idx</span>(<span class="mxinfo " id="T15:U831">2</span>,<span class="mxinfo " id="T5:U832"><span class="var type1" id="S23T5U1048">tt</span>+<span class="mxinfo " id="T5:U834">1</span></span>)</span>,<span class="mxinfo " id="T5:U835"><span class="var type1" id="S64T76U1051">currs_idx</span>(<span class="mxinfo " id="T15:U837">3</span>,<span class="mxinfo " id="T5:U838"><span class="var type1" id="S23T5U1054">tt</span>+<span class="mxinfo " id="T5:U840">1</span></span>)</span>,<span class="mxinfo " id="T5:U841"><span class="var type1" id="S23T5U1057">tt</span>+<span class="mxinfo " id="T5:U843">1</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">    <span class="mxinfo " id="T76:U844"><span class="var type1" id="S4T76U1061">predict_s</span> = <span class="mxinfo " id="T76:U846">zeros(<span class="mxinfo " id="T5:U847">3</span>,<span class="mxinfo " id="T5:U848"><span class="var type1" id="S7T5U1066">H</span>+<span class="mxinfo " id="T5:U850">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo " id="T11:U851"><span class="mxinfo " id="T11:U852"><span class="var type1" id="S4T76U1071">predict_s</span>(<span class="mxinfo " id="T69:U854">1:2</span>,<span class="mxinfo " id="T104:U855">:</span>)</span> = <span class="mxinfo " id="T11:U856">[<span class="mxinfo " id="T55:U857"><span class="mxinfo " id="T55:U858">(<span class="mxinfo " id="T55:U859"><span class="mxinfo " id="T55:U860"><span class="var type1" id="S64T76U1083">currs_idx</span>(<span class="mxinfo " id="T15:U862">2</span>,<span class="mxinfo " id="T104:U863">:</span>)</span>-<span class="mxinfo " id="T5:U864">1</span></span>)*<span class="mxinfo " id="T5:U865"><span class="var type1" id="S9T1U1088">ccdp</span>.glen</span></span>+<span class="mxinfo " id="T5:U867"><span class="mxinfo " id="T2:U868"><span class="var type1" id="S9T1U1092">ccdp</span>.xs</span>(<span class="mxinfo " id="T5:U870">1</span>)</span></span>;<span class="mxinfo " id="T55:U871"><span class="mxinfo " id="T55:U872">(<span class="mxinfo " id="T55:U873"><span class="mxinfo " id="T55:U874"><span class="var type1" id="S64T76U1101">currs_idx</span>(<span class="mxinfo " id="T15:U876">1</span>,<span class="mxinfo " id="T104:U877">:</span>)</span>-<span class="mxinfo " id="T5:U878">1</span></span>)*<span class="mxinfo " id="T5:U879"><span class="var type1" id="S9T1U1106">ccdp</span>.glen</span></span>+<span class="mxinfo " id="T5:U881"><span class="mxinfo " id="T2:U882"><span class="var type1" id="S9T1U1110">ccdp</span>.ys</span>(<span class="mxinfo " id="T5:U884">1</span>)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">    <span class="mxinfo " id="T55:U885"><span class="mxinfo " id="T55:U886"><span class="var type1" id="S4T76U1116">predict_s</span>(<span class="mxinfo " id="T15:U888">3</span>,<span class="mxinfo " id="T104:U889">:</span>)</span> = <span class="mxinfo " id="T55:U890"><span class="mxinfo " id="T55:U891"><span class="mxinfo " id="T55:U892">(<span class="mxinfo " id="T55:U893"><span class="mxinfo " id="T55:U894"><span class="var type1" id="S64T76U1125">currs_idx</span>(<span class="mxinfo " id="T15:U896">3</span>,<span class="mxinfo " id="T104:U897">:</span>)</span>-<span class="mxinfo " id="T5:U898">1</span></span>)*<span class="mxinfo " id="T5:U899">2</span></span>*<span class="mxinfo " id="T5:U900">pi</span></span>/<span class="var type1" id="S17T5U1132">ndir</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">    <span class="comment">% though we doesn't consider constraints, the optimal solution</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">    <span class="comment">% satisfies constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T13:U902"><span class="var type1" id="S66T5U1138">const_val</span>&lt;=<span class="mxinfo " id="T5:U904">0</span></span> &amp;&amp; <span class="mxinfo " id="T13:U905"><span class="var type1" id="S48T5U1141">ilagran</span>==<span class="mxinfo " id="T5:U907">1</span></span>) </span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">       <span class="comment">%fprintf('feasible\n ');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">       <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="mxinfo " id="T13:U908"><span class="var type1" id="S48T5U1147">ilagran</span>==<span class="mxinfo " id="T5:U910">1</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">       <span class="mxinfo " id="T5:U911"><span class="var type1" id="S46T5U1151">lag_feas</span>=<span class="mxinfo " id="T5:U913">0</span></span>; <span class="mxinfo " id="T5:U914"><span class="var type1" id="S44T5U1155">lagcoeff</span>=<span class="mxinfo " id="T5:U916">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    <span class="comment">% check feasibility</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T13:U917"><span class="var type1" id="S48T5U1162">ilagran</span>==<span class="mxinfo " id="T5:U919">2</span></span> &amp;&amp; <span class="mxinfo " id="T13:U920"><span class="var type1" id="S66T5U1165">const_val</span> &gt;<span class="mxinfo " id="T5:U922">0</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">        fprintf(<span class="string">'infeasible\n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">        <span class="mxinfo " id="T76:U923"><span class="var type1" id="S4T76U1174">predict_s</span>(:)=<span class="mxinfo " id="T5:U925">inf</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">        <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="mxinfo " id="T13:U926"><span class="var type1" id="S48T5U1182">ilagran</span>==<span class="mxinfo " id="T5:U928">2</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">       <span class="mxinfo " id="T5:U929"><span class="var type1" id="S44T5U1186">lagcoeff</span> = <span class="mxinfo " id="T5:U931"><span class="var type1" id="S45T25U1188">lagrng</span>(<span class="mxinfo " id="T5:U933">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">       <span class="mxinfo " id="T5:U934"><span class="var type1" id="S46T5U1192">lag_feas</span> = <span class="mxinfo " id="T5:U936">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T13:U937"><span class="var type1" id="S48T5U1198">ilagran</span>&gt;<span class="mxinfo " id="T5:U939">2</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">       <span class="keyword">if</span>(<span class="mxinfo " id="T13:U940"><span class="var type1" id="S66T5U1204">const_val</span>&gt;<span class="mxinfo " id="T5:U942">0</span></span>) <span class="comment">% violate constraints</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">           <span class="mxinfo " id="T5:U943"><span class="mxinfo " id="T5:U944"><span class="var type1" id="S45T25U1209">lagrng</span>(<span class="mxinfo " id="T5:U946">1</span>)</span> = <span class="var type1" id="S44T5U1211">lagcoeff</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">       <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">           <span class="mxinfo " id="T5:U948"><span class="mxinfo " id="T5:U949"><span class="var type1" id="S45T25U1216">lagrng</span>(<span class="mxinfo " id="T5:U951">2</span>)</span> = <span class="var type1" id="S44T5U1218">lagcoeff</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">       <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">       <span class="keyword">if</span>(<span class="mxinfo " id="T13:U953"><span class="var type1" id="S47T5U1223">flag_converge</span>==<span class="mxinfo " id="T5:U955">1</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">           <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">       <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">       <span class="keyword">if</span>(<span class="mxinfo " id="T13:U956"><span class="mxinfo " id="T5:U957"><span class="mxinfo " id="T5:U958"><span class="var type1" id="S45T25U1232">lagrng</span>(2)</span>-<span class="mxinfo " id="T5:U960"><span class="var type1" id="S45T25U1235">lagrng</span>(<span class="mxinfo " id="T5:U962">1</span>)</span></span>&lt;<span class="mxinfo " id="T5:U963">1e-2</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">           <span class="mxinfo " id="T5:U964"><span class="var type1" id="S44T5U1240">lagcoeff</span>=<span class="mxinfo " id="T5:U966"><span class="var type1" id="S45T25U1242">lagrng</span>(<span class="mxinfo " id="T5:U968">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">           <span class="mxinfo " id="T5:U969"><span class="var type1" id="S47T5U1246">flag_converge</span> = <span class="mxinfo " id="T5:U971">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">           </span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">       <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">          <span class="mxinfo " id="T5:U972"><span class="var type1" id="S44T5U1251">lagcoeff</span> = <span class="mxinfo " id="T5:U974">mean(<span class="var type1" id="S45T25U1254">lagrng</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">       <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"><span class="comment">%fprintf('the number of iterations: %d,  coeff: %.3e\n',ilagran,lagcoeff);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"><span class="comment">% wrong, initial state is not same as predict_s(:,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="mxinfo " id="T75:U976"><span class="var type1" id="S71T75U1257">movement</span>=<span class="mxinfo " id="T75:U978"><span class="mxinfo " id="T75:U979"><span class="var type1" id="S4T76U1260">predict_s</span>(<span class="mxinfo " id="T73:U981">:</span>,<span class="mxinfo " id="T5:U982">2</span>)</span>-<span class="var type1" id="S5T75U1263">pS</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"><span class="mxinfo " id="T5:U984"><span class="var type1" id="S2T5U1266">uv_opt</span> = <span class="mxinfo " id="T5:U986"><span class="mxinfo " id="T5:U987">norm(<span class="mxinfo " id="T84:U988"><span class="var type1" id="S71T75U1271">movement</span>(<span class="mxinfo " id="T69:U990">1:2</span>,<span class="mxinfo " id="T15:U991">1</span>)</span>)</span>/<span class="var type1" id="S8T5U1276">T</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line"><span class="mxinfo " id="T5:U993"><span class="var type1" id="S3T5U1279">uw_opt</span> = <span class="mxinfo " id="T5:U995">(<span class="mxinfo " id="T5:U996"><span class="var type1" id="S71T75U1283">movement</span>(3)</span>)/<span class="var type1" id="S8T5U1285">T</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"></span></span>
</pre>
